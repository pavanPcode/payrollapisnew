
CREATE VIEW PROD.VW_Registration
AS
SELECT
    r.Id                 AS RegId,
    r.SuperId,
    r.Badge,
    r.UserName,
    r.DateOfBirth,
    r.Designation,
    r.CardId,
    r.Mobile,
    r.RFID,
    r.Gender,
    r.IsActive,
    r.DateOfJoining,
    r.DateOfRegistration,
    r.MobileAccess,
    r.EmpPortalAccess,
    eb.BranchId,
    b.Name               AS BranchName,
    b.Code               AS BranchCode,
    ed.DeptId            AS DepartmentId,
    d.Name               AS DepartmentName,
    d.Code               AS DepartmentCode,
    es.ShiftId,
    s.Name               AS ShiftName,
    rd.EmailId
FROM PROD.Registration r
LEFT JOIN PROD.RegDetails rd ON rd.RegId = r.Id
LEFT JOIN PROD.EmpBranch eb ON eb.RegId = r.Id and eb.IsActive = 1
LEFT JOIN PROD.Branches b ON b.Id = eb.BranchId 
LEFT JOIN PROD.EmpDept ed ON ed.RegId = r.Id AND ed.IsActive = 1
LEFT JOIN PROD.Department d ON d.Id = ed.DeptId
LEFT JOIN PROD.EmpShift es ON es.RegId = r.Id AND es.IsActive = 1
LEFT JOIN PROD.Shifts s ON s.Id = es.ShiftId

CREATE PROCEDURE [PROD].[Sp_EmployeeRegistration]
(
	@EmployeeJson NVARCHAR(MAX),
	@RegOutId INT OUTPUT,
	@ReturnMessage NVARCHAR(500) OUTPUT,
	@ReturnStatus NVARCHAR(100) OUTPUT
)
AS
BEGIN
    SET NOCOUNT ON;
	IF ISJSON(@EmployeeJson) <> 1
        THROW 50001, 'Invalid JSON input', 1;

    BEGIN TRY
        BEGIN TRANSACTION;

		DECLARE
            @SuperId INT,
            @Badge NVARCHAR(50),
            @UserName NVARCHAR(100),
            @DateOfBirth DATE,
            @Designation NVARCHAR(100),
            @CardId NVARCHAR(20),
            @Mobile NVARCHAR(20),
            @RFID NVARCHAR(50),
            @Gender INT,
            @DateOfJoining DATE,
            @EmailId NVARCHAR(150),
            @CreatedBy INT,
            @BranchId INT,
            @DepartmentId INT,
            @ShiftId INT,
            @RegId INT,
            @CurrDT DATETIME = DATEADD(MINUTE, 330, GETUTCDATE());

        /* ---------------- Parse JSON ---------------- */
        SELECT
            @SuperId = SuperId,
            @RegId = RegId,
            @Badge = Badge,
            @UserName = UserName,
            @DateOfJoining = DateOfJoining,
            @Designation = Designation,
            @CardId = CardId,
            @Mobile = Mobile,
            @RFID = RFID,
            @DateOfBirth = DateOfBirth,
            @Gender = Gender,
            @EmailId = EmailId,
            @BranchId = BranchId,
            @DepartmentId = DepartmentId,
            @ShiftId = ShiftId,
            @CreatedBy = CreatedBy
        FROM OPENJSON(@EmployeeJson)
        WITH (
			SuperId INT          '$.superid',
			RegId INT            '$.regid',
			Badge NVARCHAR(50)   '$.badge',
			UserName NVARCHAR(100) '$.username',
			DateOfJoining DATE  '$.doj',
			Designation NVARCHAR(100) '$.designation',
			CardId NVARCHAR(20) '$.cardid',
			Mobile NVARCHAR(20) '$.mobile',
			RFID NVARCHAR(50)   '$.rfid',
			DateOfBirth DATE    '$.dateofbirth',
			Gender INT          '$.gender',
			BranchId INT        '$.branchid',
			CreatedBy INT       '$.createdby',
            EmailId NVARCHAR(150) '$.emailid',
            DepartmentId INT '$.departmentid',
            ShiftId INT  '$.shiftid'
        );
		IF @SuperId IS NULL
			THROW 50010, 'SuperId is required and missing in input JSON', 0;
        /* ---------------- Badge Validation ---------------- */

        -- New registration → badge must not exist
        IF ISNULL(@RegId, 0) = 0
        AND EXISTS (
            SELECT 1 FROM PROD.Registration
            WHERE SuperId = @SuperId
              AND CardId = @CardId
              AND IsActive = 1
        )
        THROW 50002, 'Badge already exists', 1;

        -- Update → badge must not belong to someone else
        IF ISNULL(@RegId, 0) > 0
        AND EXISTS (
            SELECT 1 FROM PROD.Registration
            WHERE SuperId = @SuperId
              AND CardId = @CardId
              AND IsActive = 1
              AND Id <> @RegId
        )
        THROW 50003, 'Badge already assigned to another employee', 1;
        PRINT 'Before insert';
        /* ---------------- Registration UPSERT ---------------- */
		DECLARE @Mode varchar(10)
        IF ISNULL(@RegId, 0) = 0
        BEGIN
			SET @Mode = 'Registered'
            INSERT INTO PROD.Registration
            (
                SuperId, Badge, UserName, DateOfJoining, Designation,
                CardId, DateOfRegistration, Mobile, RFID,
                AutoSwipeOut, IsActive, Notify,
                DateOfBirth, Gender, UpdatedBy, UpdatedOn
            )
            VALUES
            (
                @SuperId, @Badge, @UserName, @DateOfJoining, @Designation,
                @CardId, @CurrDT, @Mobile, @RFID,
                0, 1, 0,
                @DateOfBirth, @Gender, @CreatedBy, @CurrDT
            );

            SET @RegId = SCOPE_IDENTITY();
        END
        ELSE
        BEGIN
			SET @Mode = 'Updated'
            UPDATE PROD.Registration
            SET
                Badge = COALESCE(@Badge, Badge),
                DateOfBirth = COALESCE(@DateOfBirth, DateOfBirth),
                Designation = COALESCE(@Designation, Designation),
                CardId = COALESCE(@CardId, CardId),
                Mobile = COALESCE(@Mobile, Mobile),
                RFID = COALESCE(@RFID, RFID),
                Gender = COALESCE(@Gender, Gender),
                DateOfJoining = COALESCE(@DateOfJoining, DateOfJoining),
                UpdatedBy = @CreatedBy,
                UpdatedOn = @CurrDT
            WHERE Id = @RegId;
        END
        

        /* =========================================================
           REGDETAILS UPSERT (Email)
        ==========================================================*/
        IF EXISTS (SELECT 1 FROM PROD.RegDetails WHERE RegId = @RegId)
        BEGIN
            UPDATE PROD.RegDetails
            SET EmailId = COALESCE(@EmailId, EmailId)
            WHERE RegId = @RegId;
        END
        ELSE
        BEGIN
            INSERT INTO PROD.RegDetails (SuperId,RegId, EmailId)
            VALUES (@SuperId,@RegId, @EmailId);
        END

       /*=========================================================
           BRANCH UPSERT
        ==========================================================*/
        IF @BranchId IS NULL OR @BranchId = 0
        BEGIN
            SELECT @BranchId = Id
            FROM PROD.Branches 
            WHERE IsActive = 1 and SuperId = @SuperId
            GROUP BY Id
            HAVING COUNT(*) = 1;
        END

        IF EXISTS (SELECT 1 FROM PROD.EmpBranch WHERE RegId = @RegId)
        BEGIN
            UPDATE PROD.EmpBranch
            SET BranchId = COALESCE(@BranchId, BranchId),
			UpdatedBy = @CreatedBy, updatedOn = @CurrDT
            WHERE RegId = @RegId;
        END
        ELSE
        BEGIN
            INSERT INTO PROD.EmpBranch (SuperId, RegId, BranchId,IsActive, CreatedBy,CreatedOn)
            VALUES (@SuperId, @RegId, @BranchId, 1,@CreatedBy,@CurrDT);
        END

      /*=========================================================
           DEPARTMENT UPSERT
        ==========================================================*/
        IF @DepartmentId IS NULL OR @DepartmentId = 0
        BEGIN
            SELECT @DepartmentId = Id
            FROM PROD.Department
            WHERE IsActive = 1 and SuperId = @SuperId
            GROUP BY Id
            HAVING COUNT(*) = 1;
        END

        IF EXISTS (SELECT 1 FROM PROD.EmpDept WHERE RegId = @RegId AND IsActive = 1)
        BEGIN
            UPDATE PROD.EmpDept
            SET DeptId = COALESCE(@DepartmentId, DeptId)
            WHERE RegId = @RegId AND IsActive = 1;
        END
        ELSE
        BEGIN
            INSERT INTO PROD.EmpDept (RegId, DeptId, IsActive)
            VALUES (@RegId, @DepartmentId, 1);
        END

        /* =========================================================
           SHIFT UPSERT
        ==========================================================*/
        IF @ShiftId IS NULL OR @ShiftId = 0
        BEGIN
            SELECT @ShiftId = Id
            FROM PROD.Shifts
            WHERE IsActive = 1 and SuperId = @SuperId
            GROUP BY Id
            HAVING COUNT(*) = 1;
        END

        IF EXISTS (SELECT 1 FROM PROD.EmpShift WHERE RegId = @RegId AND IsActive = 1 AND EndDate IS NULL)
        BEGIN
            UPDATE PROD.EmpShift SET ShiftId = COALESCE(@ShiftId, ShiftId)
            WHERE RegId = @RegId AND IsActive = 1;
        END
        ELSE
        BEGIN
            INSERT INTO PROD.EmpShift (RegId, ShiftId,StartDate,EndDate, IsActive)
            VALUES (@RegId, @ShiftId,@CurrDT,NULL, 1);
        END
        COMMIT TRANSACTION;
		
		EXEC [PROD].[SetDayDefaultValuesForRegId] @CurrDT,@SuperId,@RegId;
		
		SET @RegOutId = @RegId;
        SET @ReturnStatus = 'Success';
		SET @ReturnMessage = CONCAT('Employee ', @Mode, ' Successfully');

    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
		SET @RegOutId = @RegId;
        SET @ReturnStatus = 'Failed';
		SET @ReturnMessage = ERROR_MESSAGE();
    END CATCH
END
GO
